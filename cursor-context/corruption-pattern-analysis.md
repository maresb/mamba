# Comprehensive Analysis: Package Metadata Corruption Patterns

<!-- markdownlint-disable MD013 MD024 -->

## Executive Summary

This document analyzes all code paths that create `PackageInfo` objects and write `repodata_record.json`, identifying potential corruption patterns and their mitigations. The analysis extends beyond the explicit lockfile bug (#4095) to examine all input formats and provenances.

## PackageInfo Creation Pathways

### 1. URL-Derived (`PackageInfo::from_url()`)

**File:** `libmamba/src/specs/package_info.cpp:220-300`

**Input Sources:**
- Explicit lockfile URLs (`.txt` files with `@EXPLICIT` header)
- `micromamba install <url>` direct URL installs
- Channel URLs that resolve to package files

**Fields Populated from URL (Trusted):**
- `name`, `version`, `build_string` (parsed from filename)
- `channel`, `platform` (parsed from URL path)
- `filename`, `package_url`
- `md5` or `sha256` (from URL hash fragment, if present)
- `package_type`

**Fields with Stub Values (Defaulted):**
| Package Type | Defaulted Fields |
|--------------|------------------|
| Conda (.tar.bz2, .conda) | `build_number`, `license`, `timestamp`, `track_features`, `depends`, `constrains` |
| Wheel (.whl) | Above + `build`, `build_string` |
| TarGz (.tar.gz) | Same as Wheel |
| Git (git+https) | Above + `version`, `channel`, `subdir`, `fn` |

**Corruption Risk:** HIGH before fix
- Stub values written to `repodata_record.json` if not erased before merge

**Mitigation (Applied):**
- `defaulted_keys` populated with `["_initialized", stub_fields...]`
- `write_repodata_record()` erases these before merging with `index.json`

---

### 2. Solver-Derived (`make_package_info()`)

**File:** `libmamba/src/solver/libsolv/helpers.cpp:107-162`

**Input Sources:**
- Normal solver operations (repodata.json → libsolv → PackageInfo)
- Packages selected by dependency resolution

**Fields Populated (All Trusted):**
- ALL fields from channel `repodata.json` (potentially patched)
- Includes intentionally empty `depends: []` or `constrains: []` from channel patches

**Corruption Risk:** LOW
- Channel patches (e.g., conda-forge repodata patches) are authoritative
- Empty arrays should NOT be overwritten by `index.json`

**Mitigation (Applied):**
- `defaulted_keys = {"_initialized"}` (only sentinel, no stub fields)
- `write_repodata_record()` preserves all fields (nothing erased)

---

### 3. Conda-lock YAML Format (`env_lockfile_conda.cpp`)

**File:** `libmamba/src/core/env_lockfile_conda.cpp:21-104`

**Input Sources:**
- Files matching `*-lock.yml` or `*-lock.yaml`
- Generated by `conda-lock` tool

**Fields from Lockfile:**
- `name`, `version` (explicit in YAML)
- `md5`, `sha256` (from `hash` node)
- `package_url` (from `url` field)
- `dependencies` (from `dependencies` map, formatted as "name constraint")
- `constrains` (from `constrains` map, if present)

**Fields Derived via `from_url()`:**
- `filename`, `channel`, `build_string`, `platform`
- `defaulted_keys` (copied from `from_url()` result)

**Corruption Risk:** MEDIUM (addressed)
- The lockfile provides `depends` and `constrains` explicitly
- However, `build_number`, `license`, `timestamp`, `track_features` still come from `from_url()` stubs

**Current Behavior (After Patches):**
```cpp
// Line 76-79: Copy defaulted_keys from from_url() result
package.info.defaulted_keys = maybe_parsed_info->defaulted_keys;
```

**Important:** The conda-lock format explicitly provides dependencies but NOT:
- `license`
- `timestamp`
- `build_number`
- `track_features`

These will be correctly backfilled from `index.json` via `defaulted_keys` mechanism.

---

### 4. MambaJS JSON Format (`env_lockfile_mambajs.cpp`)

**File:** `libmamba/src/core/env_lockfile_mambajs.cpp:35-108`

**Input Sources:**
- Files with `.json` extension
- Generated by mambajs ecosystem

**Fields from Lockfile:**
- `name`, `version` (explicit)
- `md5`, `sha256` (from `hash` object)
- `channel` (explicit for conda), `registry` (for pip)
- `platform`/`subdir` (for conda packages)
- `build_string` (from `build` field for conda)

**Fields NOT in Lockfile (Stub Values):**
- `license`
- `timestamp`
- `build_number`
- `track_features`
- `depends` (NOT provided in mambajs format!)
- `constrains`

**Corruption Risk:** HIGH before fix

**Current Behavior (After Patches):**
```cpp
// Lines 99-105: Set defaulted_keys explicitly
package.info.defaulted_keys = { "_initialized", "build_number",   "license",
                                "timestamp",    "track_features", "depends",
                                "constrains" };
```

**Key Insight:** Unlike conda-lock, mambajs lockfiles do NOT contain dependency information. Dependencies must be read from `index.json` at extraction time.

---

### 5. Constructor Path (`constructor.cpp`)

**File:** `micromamba/src/constructor.cpp:70-256`

**Input Sources:**
- `pkgs/urls` file (list of package URLs)
- Used by `conda constructor` for installer creation

**Unique Characteristics:**
- Uses cached `repodata.json` when available (via `find_package()`)
- Falls back to `index.json` + URL-derived info if cache unavailable

**Code Flow:**
```cpp
// Line 109: Parse URL
auto pkg_info = specs::PackageInfo::from_url(raw_url).value();

// Lines 134-145: Try to find in cached repodata
if (fs::exists(repodata_location)) {
    repodata_record = find_package(j, pkg_info.filename);
}

// Lines 151-194: Handle based on repodata availability
if (!repodata_record.is_null()) {
    // Use cached repodata, apply defaulted_keys if _initialized present
} else {
    // Fall back to index.json
}
```

**Corruption Risk:** MEDIUM
- Different behavior than `package_fetcher.cpp`
- NO fail-hard check (intentional - see comment)

**Why No Fail-Hard:**
```cpp
// Lines 153-173: Explanation
// - package_fetcher.cpp: PackageInfo always from from_url() or make_package_info()
// - constructor.cpp: May come from cached repodata (via from_json())
// Cached repodata should be trusted (may contain channel patches)
```

---

### 6. JSON Deserialization (`from_json()`)

**File:** `libmamba/src/specs/package_info.cpp:570-619`

**Input Sources:**
- Reading existing `repodata_record.json` files (PrefixData)
- Loading cached repodata entries
- Display operations (`mamba list`, etc.)

**Important:** `from_json()` does NOT set `_initialized`

**Why This Is Correct:**
- Deserialized PackageInfo is for reading, not writing
- These objects are used for dependency computation, display, etc.
- They are never passed to `write_repodata_record()`

**If Passed to Write:**
- Would trigger fail-hard in `package_fetcher.cpp`
- Would be trusted in `constructor.cpp` (as cached repodata)

---

### 7. Direct Constructors

**Files:** `libmamba/src/specs/package_info.cpp:302-321`

**Usage:**
- `PackageInfo(name)` - minimal construction
- `PackageInfo(name, version, build, build_number)`
- `PackageInfo(name, version, build, channel)`

**Corruption Risk:** LOW
- These are primarily used for internal operations
- Not typically passed to `write_repodata_record()`
- If they were, fail-hard would catch missing `_initialized`

---

## Corruption Patterns by Version

### v2.1.1 - v2.3.2 (Full Corruption)

**Pattern:** ALL stub fields written to `repodata_record.json`

| Field | Expected | Actual |
|-------|----------|--------|
| `depends` | From index.json | `[]` |
| `constrains` | From index.json | `[]` |
| `license` | From index.json | `""` |
| `timestamp` | From index.json | `0` |
| `build_number` | From index.json | `0` |
| `track_features` | From index.json | `""` |

**Impact:**
- Dependency information lost → incorrect environment resolution
- License tracking broken
- Package provenance unclear (timestamp)

---

### v2.3.3 (Partial Fix - PR #4071)

**Pattern:** `depends` and `constrains` conditionally fixed

```cpp
// Original v2.3.3 fix (insufficient)
if (repodata_record["depends"].empty())
    repodata_record.erase("depends");
if (repodata_record["constrains"].empty())
    repodata_record.erase("constrains");
repodata_record.insert(index.cbegin(), index.cend());
```

**Problem:** This also erases intentionally empty arrays from channel patches!

| Field | Expected | Actual |
|-------|----------|--------|
| `depends` | From index.json (for URL-derived) | ✓ Correct |
| `depends` | `[]` (for patched solver-derived) | ✗ Overwritten by index.json |
| `constrains` | From index.json (for URL-derived) | ✓ Correct |
| `license` | From index.json | `""` (still broken) |
| `timestamp` | From index.json | `0` (still broken) |
| `build_number` | From index.json | `0` (still broken) |
| `track_features` | From index.json | `""` (still broken) |

---

### Current (After Patches)

**Pattern:** Full fix using `defaulted_keys` mechanism

**URL-Derived Packages:**
1. `from_url()` sets `defaulted_keys = ["_initialized", "license", "timestamp", ...]`
2. `write_repodata_record()` erases all defaulted keys (except sentinel)
3. `insert()` fills from `index.json`
4. All fields correct

**Solver-Derived Packages:**
1. `make_package_info()` sets `defaulted_keys = ["_initialized"]`
2. `write_repodata_record()` erases nothing (only sentinel in list)
3. `insert()` does nothing (all fields already present)
4. Channel patches preserved

**Cache Healing:**
1. `has_valid_extracted_dir()` detects corruption signature (`timestamp=0 AND license=""`)
2. Returns `valid=false` → triggers re-extraction
3. Fresh `write_repodata_record()` writes correct values

---

## Edge Cases and Remaining Concerns

### 1. Packages Without License

**Scenario:** Legitimate package with no license field in `index.json`

**Behavior:**
- `repodata_record.json` will have `license: ""` (from insert)
- NOT detected as corruption (needs BOTH timestamp=0 AND license="")
- Correct behavior

### 2. Packages With timestamp=0

**Scenario:** Rare package built before timestamp standardization

**Behavior:**
- If `license` is non-empty → NOT detected as corruption
- If `license` is empty → DETECTED as corruption, re-extracted
- Acceptable false-positive rate (extremely rare combination)

### 3. MambaJS Lockfiles Without Dependencies

**Scenario:** MambaJS format doesn't include dependency information

**Behavior:**
- `depends` in `defaulted_keys` → erased → filled from `index.json`
- Correct behavior

**Important Note:** This differs from conda-lock which DOES include dependencies

### 4. Channel Patches with Empty depends=[]

**Scenario:** conda-forge patches a package to have no dependencies

**Behavior:**
- Solver creates PackageInfo with `depends: []` and `defaulted_keys: ["_initialized"]`
- `write_repodata_record()` preserves empty array
- Correct behavior (patch honored)

### 5. Mixed Solver + URL Installation

**Scenario:** Some packages from solver, some from explicit URLs

**Behavior:**
- Each PackageInfo has appropriate `defaulted_keys`
- Each handled correctly independently
- Correct behavior

### 6. Constructor with Missing Repodata Cache

**Scenario:** `pkgs/cache/` doesn't have repodata for package's channel

**Behavior:**
```cpp
// constructor.cpp lines 201-214
repodata_record = index;  // Start with index.json
repodata_record["fn"] = pkg_info.filename;
repodata_record["url"] = pkg_info.package_url;
repodata_record["channel"] = pkg_info.channel;
repodata_record["size"] = fs::file_size(entry);
// md5/sha256 from URL fragment if available
```

**Result:** Correct metadata from index.json, URL-derived fields added

---

## Summary: Input Format Risk Matrix

| Input Format | File | defaulted_keys Set? | Risk Level | Notes |
|--------------|------|---------------------|------------|-------|
| Explicit URL | package_info.cpp | ✓ (from_url) | Mitigated | Full stub field list |
| Solver/Repodata | helpers.cpp | ✓ (make_package_info) | Low | Only sentinel |
| conda-lock YAML | env_lockfile_conda.cpp | ✓ (inherited) | Mitigated | deps from lockfile |
| MambaJS JSON | env_lockfile_mambajs.cpp | ✓ (explicit) | Mitigated | deps from index.json |
| Constructor | constructor.cpp | ✓ (inherited) | Mitigated | Cached repodata trusted |
| from_json() | package_info.cpp | ✗ | N/A | Never written |
| Constructors | package_info.cpp | ✗ | Caught | Fail-hard check |

---

## Verification Checklist

### For Any New PackageInfo Creation Path:

1. ☐ Does it set `defaulted_keys` with `_initialized` sentinel?
2. ☐ Does it list all fields with stub/default values?
3. ☐ If not setting `defaulted_keys`, is it intentionally read-only?
4. ☐ If passed to `write_repodata_record()`, will fail-hard catch it?

### For Any New Write Path:

1. ☐ Does it use `defaulted_keys` to erase stubs before merge?
2. ☐ Does it preserve solver-derived values (only `_initialized` in list)?
3. ☐ Does it ensure `depends`/`constrains` are always arrays?
4. ☐ Does it handle missing checksums (compute from tarball)?

---

## Additional Read-Only PackageInfo Paths (Safe)

### Virtual Packages (`virtual_packages.cpp`)

**File:** `libmamba/src/core/virtual_packages.cpp:195-211`

**Purpose:** Creates PackageInfo for system virtual packages (`__cuda`, `__glibc`, `__archspec`, etc.)

**Example:**
```cpp
specs::PackageInfo res(std::move(name));
res.version = version.empty() ? "0" : std::move(version);
res.channel = "@";  // Special "@" channel indicates virtual
```

**Risk:** NONE
- Virtual packages are never written to disk
- Used only for solver constraints
- `channel = "@"` clearly marks them as special

### History Parsing (`history.cpp`)

**File:** `libmamba/src/core/history.cpp:331-379`

**Purpose:** Parses history file entries back to PackageInfo for display

**Example:**
```cpp
specs::PackageInfo pkg_info{ name, version, build_string, channel };
return pkg_info;  // For display only
```

**Risk:** NONE
- Read-only for history display
- Never passed to write operations

---

## Appendix: Test Coverage

| Scenario | Test File | Test Name |
|----------|-----------|-----------|
| from_url populates defaulted_keys | test_package_info.cpp | "from_url populates defaulted_keys" |
| URL metadata from index.json | test_package_fetcher.cpp | "write_repodata_record uses index.json" |
| Channel patch preservation | test_package_fetcher.cpp | "preserves channel patched empty depends" |
| Cache healing | test_package_fetcher.cpp | "heals existing corrupted cache" |
| No false positive healing | test_package_fetcher.cpp | "no false positive cache healing" |
| Consistent field presence | test_package_fetcher.cpp | "ensures depends/constrains present" |
| Checksum computation | test_package_fetcher.cpp | "ensures both checksums" |
| Constructor metadata | test_constructor.py | TestURLDerivedMetadata |
| Lockfile defaulted_keys | test_package_info.cpp | "lockfile packages have _initialized" |
