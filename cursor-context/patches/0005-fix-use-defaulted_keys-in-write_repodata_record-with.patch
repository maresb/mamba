From c772a0d66dc88f716f1dab9e0a86b382d1690914 Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Sat, 29 Nov 2025 00:36:00 +0000
Subject: [PATCH 05/13] fix: use defaulted_keys in write_repodata_record() with
 fail-hard (GREEN)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Fix URL-derived package corruption and preserve channel patches by using
the defaulted_keys mechanism in write_repodata_record().

Implementation:

1. FAIL-HARD CHECK: Verify "_initialized" sentinel is present
   - Throws std::logic_error if missing
   - This catches any code path that fails to set defaulted_keys
   - All paths now set it: from_url(), make_package_info()

2. ERASE STUB FIELDS: Remove fields listed in defaulted_keys before merge
   - URL-derived: erases build_number, license, timestamp, etc.
   - Solver-derived: defaulted_keys = {"_initialized"}, nothing erased
   - This preserves channel patches with intentionally empty arrays

3. MERGE WITH INDEX.JSON: insert() fills erased fields
   - URL-derived: gets correct values from index.json
   - Solver-derived: all fields already present, index.json ignored

Why this works:
- URL packages: {"_initialized", "license", ...} → stubs erased → index.json fills
- Solver packages: {"_initialized"} → nothing erased → patch preserved

Test Status: ALL TESTS PASS (GREEN phase)
- test cases: 4 | 4 passed
- assertions: 32 | 32 passed

Tests fixed:
- write_repodata_record uses index.json for URL-derived metadata
- write_repodata_record preserves channel patched empty depends
- write_repodata_record preserves channel patched empty constrains

Related: https://github.com/mamba-org/mamba/issues/4095
---
 libmamba/src/core/package_fetcher.cpp | 46 ++++++++++++++++++++-------
 1 file changed, 35 insertions(+), 11 deletions(-)

diff --git a/libmamba/src/core/package_fetcher.cpp b/libmamba/src/core/package_fetcher.cpp
index e1014f74..a7b0aa74 100644
--- a/libmamba/src/core/package_fetcher.cpp
+++ b/libmamba/src/core/package_fetcher.cpp
@@ -439,22 +439,46 @@ namespace mamba

         nlohmann::json repodata_record = m_package_info;

-        // For explicit spec files (URLs), m_package_info has empty depends/constrains arrays
-        // that would overwrite the correct values from index.json. Remove these empty fields.
-        if (auto depends_it = repodata_record.find("depends");
-            depends_it != repodata_record.end() && depends_it->empty())
+        // FAIL-HARD CHECK: All PackageInfo creation paths MUST set "_initialized" sentinel.
+        // - URL-derived packages: from_url() sets {"_initialized", stub_fields...}
+        // - Solver-derived packages: make_package_info() sets {"_initialized"}
+        // If missing, this is a bug in a code path that creates PackageInfo.
+        // See GitHub issue #4095 for details.
+        auto contains_initialized = [&]()
         {
-            repodata_record.erase("depends");
+            return std::find(
+                       m_package_info.defaulted_keys.begin(),
+                       m_package_info.defaulted_keys.end(),
+                       "_initialized"
+                   )
+                   != m_package_info.defaulted_keys.end();
+        };
+        if (!contains_initialized())
+        {
+            throw std::logic_error(
+                "PackageInfo missing _initialized sentinel in defaulted_keys. "
+                "This indicates a bug in the code path that created this PackageInfo. "
+                "See GitHub issue #4095."
+            );
         }
-        if (auto constrains_it = repodata_record.find("constrains");
-            constrains_it != repodata_record.end() && constrains_it->empty())
+
+        // Erase fields listed in defaulted_keys (except "_initialized") before merging.
+        // - URL-derived packages: listed fields have stub values (0, "", [])
+        //   → erase them so index.json provides correct values
+        // - Solver-derived packages: only "_initialized" in list
+        //   → nothing erased, all fields preserved (including channel patches)
+        for (const auto& key : m_package_info.defaulted_keys)
         {
-            repodata_record.erase("constrains");
+            if (key != "_initialized")
+            {
+                repodata_record.erase(key);
+            }
         }

-        // To take correction of packages metadata (e.g. made using repodata patches) into account,
-        // we insert the index into the repodata record to only add new fields from the index
-        // while keeping the existing fields from the repodata record.
+        // Merge with index.json: insert() only adds MISSING keys.
+        // - URL-derived: erased stub fields are filled from index.json
+        // - Solver-derived: all fields already present, nothing added from index.json
+        //   (preserves channel patches with intentionally empty arrays)
         repodata_record.insert(index.cbegin(), index.cend());

         if (repodata_record.find("size") == repodata_record.end() || repodata_record["size"] == 0)
--
2.50.1
