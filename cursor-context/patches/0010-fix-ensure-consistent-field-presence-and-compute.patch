From 9ee33d531b708a6b560f9d2ed6b7d3c9997ff9ab Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Sat, 29 Nov 2025 00:44:46 +0000
Subject: [PATCH 10/13] fix: ensure consistent field presence and compute
 missing checksums (GREEN)

Ensure repodata_record.json has consistent field presence and checksums
matching conda behavior.

Changes in write_repodata_record():

1. depends/constrains always present:
   - Add empty arrays if fields are missing after merge
   - Some packages (like nlohmann_json-abi) lack these in index.json
   - Matches conda's expected record structure

2. track_features conditionally included:
   - Remove field if empty (null, "", or [])
   - Reduces JSON noise for majority of packages
   - Matches conda behavior

3. Both checksums always present:
   - Compute md5 from tarball if missing/empty
   - Compute sha256 from tarball if missing/empty
   - Ensures cache validation always has checksums

Test results:
- "*ensures depends/constrains*": PASSED (9 assertions)
  - Verifies depends/constrains added as empty arrays when missing
- "*omits empty track_features*": PASSED (4 assertions)
  - Verifies track_features removed when empty
- "*ensures both checksums*": PASSED (7 assertions)
  - Verifies md5 and sha256 computed from tarball
- All PackageFetcher tests: PASSED (46 assertions in 7 test cases)
- All PackageInfo tests: PASSED (145 assertions in 3 test cases)

Related: https://github.com/mamba-org/mamba/issues/4095
---
 libmamba/src/core/package_fetcher.cpp | 40 +++++++++++++++++++++++++++
 1 file changed, 40 insertions(+)

diff --git a/libmamba/src/core/package_fetcher.cpp b/libmamba/src/core/package_fetcher.cpp
index a7b0aa74..315454e5 100644
--- a/libmamba/src/core/package_fetcher.cpp
+++ b/libmamba/src/core/package_fetcher.cpp
@@ -486,6 +486,46 @@ namespace mamba
             repodata_record["size"] = fs::file_size(m_tarball_path);
         }

+        // Ensure depends and constrains are always present as arrays.
+        // Matches conda behavior where these fields are always present.
+        // Some packages (like nlohmann_json-abi) don't have depends in index.json.
+        // See GitHub issue #4095.
+        if (!repodata_record.contains("depends"))
+        {
+            repodata_record["depends"] = nlohmann::json::array();
+        }
+        if (!repodata_record.contains("constrains"))
+        {
+            repodata_record["constrains"] = nlohmann::json::array();
+        }
+
+        // Conditionally include track_features only when non-empty.
+        // Matches conda behavior to reduce JSON noise.
+        // See GitHub issue #4095.
+        if (repodata_record.contains("track_features"))
+        {
+            const auto& tf = repodata_record["track_features"];
+            bool is_empty = tf.is_null() || (tf.is_string() && tf.get<std::string>().empty())
+                            || (tf.is_array() && tf.empty());
+            if (is_empty)
+            {
+                repodata_record.erase("track_features");
+            }
+        }
+
+        // Ensure both md5 and sha256 checksums are always present.
+        // Compute from tarball if not available from PackageInfo or index.json.
+        // See GitHub issue #4095.
+        if (!repodata_record.contains("md5") || repodata_record["md5"].get<std::string>().empty())
+        {
+            repodata_record["md5"] = validation::md5sum(m_tarball_path);
+        }
+        if (!repodata_record.contains("sha256")
+            || repodata_record["sha256"].get<std::string>().empty())
+        {
+            repodata_record["sha256"] = validation::sha256sum(m_tarball_path);
+        }
+
         std::ofstream repodata_record_file(repodata_record_path.std_path());
         repodata_record_file << repodata_record.dump(4);
     }
--
2.50.1
