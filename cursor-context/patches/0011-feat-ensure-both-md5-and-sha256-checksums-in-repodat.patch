From edbcf28bb5a08b28193c8978e5713d9ddbbb834c Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Wed, 26 Nov 2025 01:04:16 +0000
Subject: [PATCH 11/11] feat: ensure both md5 and sha256 checksums in
 repodata_record.json (GREEN)

When writing repodata_record.json, compute any missing checksums
from the tarball. This ensures both md5 and sha256 are always present,
even when installing from an explicit lockfile that only contains md5.

Applied to both package_fetcher.cpp and constructor.cpp.
---
 libmamba/src/core/package_fetcher.cpp | 17 +++++++++++++++++
 micromamba/src/constructor.cpp        | 18 ++++++++++++++++++
 2 files changed, 35 insertions(+)

diff --git a/libmamba/src/core/package_fetcher.cpp b/libmamba/src/core/package_fetcher.cpp
index aa0c6586..4ddf348c 100644
--- a/libmamba/src/core/package_fetcher.cpp
+++ b/libmamba/src/core/package_fetcher.cpp
@@ -518,6 +518,23 @@ namespace mamba
             repodata_record["size"] = fs::file_size(m_tarball_path);
         }

+        // Ensure both md5 and sha256 checksums are always present.
+        // When installing from an explicit lockfile, typically only md5 is available.
+        // We compute any missing checksums from the tarball.
+        bool has_md5 = repodata_record.contains("md5") && repodata_record["md5"].is_string()
+                       && !repodata_record["md5"].get<std::string>().empty();
+        bool has_sha256 = repodata_record.contains("sha256") && repodata_record["sha256"].is_string()
+                          && !repodata_record["sha256"].get<std::string>().empty();
+
+        if (!has_md5)
+        {
+            repodata_record["md5"] = validation::md5sum(m_tarball_path);
+        }
+        if (!has_sha256)
+        {
+            repodata_record["sha256"] = validation::sha256sum(m_tarball_path);
+        }
+
         std::ofstream repodata_record_file(repodata_record_path.std_path());
         repodata_record_file << repodata_record.dump(4);
     }
diff --git a/micromamba/src/constructor.cpp b/micromamba/src/constructor.cpp
index 021cdb68..37e70d5a 100644
--- a/micromamba/src/constructor.cpp
+++ b/micromamba/src/constructor.cpp
@@ -13,6 +13,7 @@
 #include "mamba/core/subdir_index.hpp"
 #include "mamba/core/util.hpp"
 #include "mamba/util/string.hpp"
+#include "mamba/validation/tools.hpp"


 using namespace mamba;  // NOLINT(build/namespaces)
@@ -249,6 +250,23 @@ construct(Configuration& config, const fs::u8path& prefix, bool extract_conda_pk
                 repodata_record["size"] = fs::file_size(entry);
             }

+            // Ensure both md5 and sha256 checksums are always present.
+            // We compute any missing checksums from the tarball.
+            bool has_md5 = repodata_record.contains("md5") && repodata_record["md5"].is_string()
+                           && !repodata_record["md5"].get<std::string>().empty();
+            bool has_sha256 = repodata_record.contains("sha256")
+                              && repodata_record["sha256"].is_string()
+                              && !repodata_record["sha256"].get<std::string>().empty();
+
+            if (!has_md5)
+            {
+                repodata_record["md5"] = validation::md5sum(entry);
+            }
+            if (!has_sha256)
+            {
+                repodata_record["sha256"] = validation::sha256sum(entry);
+            }
+
             LOG_TRACE << "Writing " << repodata_record_path;
             std::ofstream repodata_record_of{ repodata_record_path.std_path() };
             repodata_record_of << repodata_record.dump(4);
--
2.50.1
