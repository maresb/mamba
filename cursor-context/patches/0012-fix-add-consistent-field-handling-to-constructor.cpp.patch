From 5ba5d313aa11da75d84a61b0c5ce8b703e74d090 Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Sat, 29 Nov 2025 08:42:07 +0000
Subject: [PATCH 12/13] fix: add consistent field handling to constructor.cpp

Apply the same field consistency logic from package_fetcher.cpp to
constructor.cpp to ensure uniform behavior across all package
extraction paths.

Changes:
1. Ensure depends/constrains always present as arrays
   - Add empty arrays if fields are missing after merge
   - Some packages don't have these in index.json

2. Conditionally include track_features
   - Remove field if empty (null, "", or [])
   - Reduces JSON noise

This complements the earlier defaulted_keys fix (Commit 09) which
handles the URL-derived metadata stub replacement.

Verification:
- Syntax verified: pixi run g++ -std=c++20 -fsyntax-only ... PASSED
- Full build blocked by static library dependencies (yaml-cpp, reproc)
- All libmamba C++ tests pass (46+145 assertions)

Note: Checksum computation not added to constructor.cpp because it
handles checksums differently:
- md5 comes from URL fragment in urls file (e.g., url#hash)
- If repodata cache exists, checksums come from there
- Only fallback case uses index.json (which typically lacks checksums)

Related: https://github.com/mamba-org/mamba/issues/4095
---
 micromamba/src/constructor.cpp | 27 +++++++++++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git a/micromamba/src/constructor.cpp b/micromamba/src/constructor.cpp
index 12d41796..03abf6b1 100644
--- a/micromamba/src/constructor.cpp
+++ b/micromamba/src/constructor.cpp
@@ -213,6 +213,33 @@ construct(Configuration& config, const fs::u8path& prefix, bool extract_conda_pk
                 repodata_record["size"] = fs::file_size(entry);
             }

+            // Ensure depends and constrains are always present as arrays.
+            // Matches conda behavior where these fields are always present.
+            // Some packages (like nlohmann_json-abi) don't have depends in index.json.
+            // See GitHub issue #4095.
+            if (!repodata_record.contains("depends"))
+            {
+                repodata_record["depends"] = nlohmann::json::array();
+            }
+            if (!repodata_record.contains("constrains"))
+            {
+                repodata_record["constrains"] = nlohmann::json::array();
+            }
+
+            // Conditionally include track_features only when non-empty.
+            // Matches conda behavior to reduce JSON noise.
+            // See GitHub issue #4095.
+            if (repodata_record.contains("track_features"))
+            {
+                const auto& tf = repodata_record["track_features"];
+                bool is_empty = tf.is_null() || (tf.is_string() && tf.get<std::string>().empty())
+                                || (tf.is_array() && tf.empty());
+                if (is_empty)
+                {
+                    repodata_record.erase("track_features");
+                }
+            }
+
             LOG_TRACE << "Writing " << repodata_record_path;
             std::ofstream repodata_record_of{ repodata_record_path.std_path() };
             repodata_record_of << repodata_record.dump(4);
--
2.50.1
