From 7225e247d9f259f9f9893ec7745e5eab7e19bf8d Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Sun, 9 Nov 2025 16:23:13 +0000
Subject: [PATCH 02/11] fix: populate defaulted_keys for all URL-derived
 package types

Mark stub fields in PackageInfo created from URLs so they can be replaced
with actual values from index.json during extraction.

For conda packages (.conda, .tar.bz2):
- Marks: build_number, license, timestamp, track_features, depends, constrains

For wheel packages:
- Additionally marks: build, build_string (format-specific fields)
- Note: Wheels are not extracted by mamba (pip handles installation).
  This is for API consistency only.

For tar.gz packages:
- Same as wheels (build, build_string, + standard fields)

For git URL packages (git+https://...#egg=name):
- Marks: build, build_string, build_number, license, timestamp,
  track_features, depends, constrains
- Note: Git URLs are also not extracted by mamba in practice. For API
  consistency only.

These fields get stub values during URL parsing because URLs don't contain
this metadata. By marking them as defaulted, we enable extraction logic to
replace them with correct values from index.json.

Test Status: ALL STILL FAIL (expected - defaulted_keys not yet used)
- test cases: 3 | 0 passed | 3 failed
- Same failures - write_repodata_record() doesn't yet use defaulted_keys
---
 libmamba/src/specs/package_info.cpp | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/libmamba/src/specs/package_info.cpp b/libmamba/src/specs/package_info.cpp
index cfe776fc..0b0c9e24 100644
--- a/libmamba/src/specs/package_info.cpp
+++ b/libmamba/src/specs/package_info.cpp
@@ -95,6 +95,10 @@ namespace mamba::specs

                 // Name
                 out.name = head.value();  // There may be '-' in the name
+
+                // Mark fields that have stub/default values for URL-derived conda packages
+                out.defaulted_keys = { "build_number",   "license", "timestamp",
+                                       "track_features", "depends", "constrains" };
             }
             // PackageType::Wheel (.whl):
             // {pkg name}-{version}-{build tag (optional)}-{python tag}-{abi tag}-{platform tag}.whl
@@ -140,6 +144,11 @@ namespace mamba::specs
                     out.version = tail;
                     // The head is the name
                     out.name = head.value();  // There may be '-' in the name
+
+                    // Mark fields that have stub/default values for URL-derived wheel packages
+                    out.defaulted_keys = { "build",   "build_string", "build_number",
+                                           "license", "timestamp",    "track_features",
+                                           "depends", "constrains" };
                 }
                 else
                 {
@@ -156,6 +165,11 @@ namespace mamba::specs

                     // Name
                     out.name = head.value();  // There may be '-' in the name
+
+                    // Mark fields that have stub/default values for URL-derived wheel packages
+                    out.defaulted_keys = { "build",   "build_string", "build_number",
+                                           "license", "timestamp",    "track_features",
+                                           "depends", "constrains" };
                 }
             }
             // PackageType::TarGz (.tar.gz): {pkg name}-{version}.tar.gz
@@ -173,6 +187,10 @@ namespace mamba::specs

                 // Name
                 out.name = head.value();  // There may be '-' in the name
+
+                // Mark fields that have stub/default values for URL-derived tar.gz packages
+                out.defaulted_keys = { "build",     "build_string",   "build_number", "license",
+                                       "timestamp", "track_features", "depends",      "constrains" };
             }

             return out;
--
2.50.1
