From ece1c1c2350b5700977d49c358b52e5bcaf2fbb5 Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Sat, 29 Nov 2025 00:33:13 +0000
Subject: [PATCH 03/13] fix: add _initialized to make_package_info() for solver
 path
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Set defaulted_keys = {"_initialized"} for solver-derived packages created
by make_package_info(). This enables fail-hard verification in
write_repodata_record().

Solver-derived packages have authoritative metadata from channel repodata
(potentially patched). We set only "_initialized" without listing stub
fields to signal "trust all fields, including intentionally-empty arrays".

This is critical for preserving channel patches:
- If channel repodata patches set depends=[] to fix broken deps
- The empty array must be preserved in repodata_record.json
- Setting defaulted_keys={"_initialized"} (no stub fields) prevents erasure

Semantics:
- defaulted_keys = {"_initialized"} → trust all fields (solver path)
- defaulted_keys = {"_initialized", "license", ...} → listed fields are stubs
- Missing "_initialized" → bug, will fail hard in write_repodata_record()

Test Status: ALL TESTS PASS
- No new tests (prepares infrastructure for fail-hard check)
- Existing tests: 97 assertions pass

Related: https://github.com/mamba-org/mamba/issues/4095
---
 libmamba/src/solver/libsolv/helpers.cpp | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/libmamba/src/solver/libsolv/helpers.cpp b/libmamba/src/solver/libsolv/helpers.cpp
index f1effd9b..673d51d2 100644
--- a/libmamba/src/solver/libsolv/helpers.cpp
+++ b/libmamba/src/solver/libsolv/helpers.cpp
@@ -146,6 +146,13 @@ namespace mamba::solver::libsolv
             std::transform(feats.begin(), feats.end(), std::back_inserter(out.track_features), id_to_str);
         }

+        // Set "_initialized" sentinel to indicate this PackageInfo was properly constructed.
+        // Solver-derived packages have authoritative metadata from channel repodata (potentially
+        // patched). We set only _initialized (no stub field names) to signal "trust all fields".
+        // This preserves channel patches with intentionally empty arrays.
+        // See issue #4095.
+        out.defaulted_keys = { "_initialized" };
+
         return out;
     }

--
2.50.1
