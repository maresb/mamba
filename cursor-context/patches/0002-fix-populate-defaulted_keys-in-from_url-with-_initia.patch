From 111c336f9aa90bbaf9e885043a1b54cbc71cebc8 Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Sat, 29 Nov 2025 00:32:02 +0000
Subject: [PATCH 02/13] fix: populate defaulted_keys in from_url() with
 _initialized sentinel (GREEN)

Populate the defaulted_keys field in PackageInfo::from_url() to mark which
fields have stub/default values. This enables write_repodata_record() to
erase these stubs before merging with index.json.

The "_initialized" sentinel is placed first in defaulted_keys. This is used
for fail-hard verification: write_repodata_record() will throw if _initialized
is missing, catching any code path that fails to set defaulted_keys.

Per package type:
- Conda (.conda, .tar.bz2): _initialized + build_number, license, timestamp,
  track_features, depends, constrains
- Wheel (.whl): Above + build, build_string (not in wheel filename)
- TarGz (.tar.gz): Same as wheels
- Git URLs: Same as wheels (git URLs provide minimal info)

Fields NOT in defaulted_keys (always valid from URL):
- name, version, build_string (for conda), channel, package_url, platform,
  filename, md5/sha256 (when hash fragment present)

Test Status: ALL TESTS PASS (GREEN phase)
- test cases: 1 | 1 passed
- assertions: 46 | 46 passed

Tests fixed:
- PackageInfo::from_url populates defaulted_keys (all 5 sections)

Related: https://github.com/mamba-org/mamba/issues/4095
---
 libmamba/src/specs/package_info.cpp | 34 +++++++++++++++++++++++++++++
 1 file changed, 34 insertions(+)

diff --git a/libmamba/src/specs/package_info.cpp b/libmamba/src/specs/package_info.cpp
index 29bfa01a..164116a1 100644
--- a/libmamba/src/specs/package_info.cpp
+++ b/libmamba/src/specs/package_info.cpp
@@ -95,6 +95,13 @@ namespace mamba::specs

                 // Name
                 out.name = head.value();  // There may be '-' in the name
+
+                // Mark fields that have stub/default values for URL-derived conda packages.
+                // These fields are NOT available from the URL and will use struct defaults.
+                // The "_initialized" sentinel enables fail-hard verification in
+                // write_repodata_record(). See issue #4095.
+                out.defaulted_keys = { "_initialized", "build_number",   "license", "timestamp",
+                                       "track_features", "depends", "constrains" };
             }
             // PackageType::Wheel (.whl):
             // {pkg name}-{version}-{build tag (optional)}-{python tag}-{abi tag}-{platform tag}.whl
@@ -140,6 +147,13 @@ namespace mamba::specs
                     out.version = tail;
                     // The head is the name
                     out.name = head.value();  // There may be '-' in the name
+
+                    // Mark fields that have stub/default values for URL-derived wheel packages.
+                    // Wheels don't have build info in the filename, so add build/build_string.
+                    // The "_initialized" sentinel enables fail-hard verification. See issue #4095.
+                    out.defaulted_keys = { "_initialized", "build",           "build_string",
+                                           "build_number", "license",         "timestamp",
+                                           "track_features", "depends",       "constrains" };
                 }
                 else
                 {
@@ -156,6 +170,13 @@ namespace mamba::specs

                     // Name
                     out.name = head.value();  // There may be '-' in the name
+
+                    // Mark fields that have stub/default values for URL-derived wheel packages.
+                    // Wheels don't have build info in the filename, so add build/build_string.
+                    // The "_initialized" sentinel enables fail-hard verification. See issue #4095.
+                    out.defaulted_keys = { "_initialized", "build",           "build_string",
+                                           "build_number", "license",         "timestamp",
+                                           "track_features", "depends",       "constrains" };
                 }
             }
             // PackageType::TarGz (.tar.gz): {pkg name}-{version}.tar.gz
@@ -173,6 +194,12 @@ namespace mamba::specs

                 // Name
                 out.name = head.value();  // There may be '-' in the name
+
+                // Mark fields that have stub/default values for URL-derived tar.gz packages.
+                // Similar to wheels: no build info in filename. See issue #4095.
+                out.defaulted_keys = { "_initialized", "build",           "build_string",
+                                       "build_number", "license",         "timestamp",
+                                       "track_features", "depends",       "constrains" };
             }

             return out;
@@ -251,6 +278,13 @@ namespace mamba::specs
             {
                 pkg.name = str.substr(idx + pkg_name_marker.length());
             }
+
+            // Mark fields that have stub/default values for git URL packages.
+            // Git URLs only provide package_url and optionally name (from #egg=).
+            // All other fields use struct defaults. See issue #4095.
+            pkg.defaulted_keys = { "_initialized", "build",           "build_string",
+                                   "build_number", "license",         "timestamp",
+                                   "track_features", "depends",       "constrains" };
             return pkg;
         }

--
2.50.1
