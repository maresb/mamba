From f5311176a6fe7ad4f3c4f3e142de637af7a6c6ae Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Sat, 29 Nov 2025 00:43:14 +0000
Subject: [PATCH 09/13] test: add tests for consistent field presence and
 checksums (RED)

Add failing tests that verify repodata_record.json consistency:

1. depends/constrains presence test (FAILS):
   - Tests that depends and constrains are always present as arrays
   - Even when index.json lacks these fields (like nlohmann_json-abi)
   - Matches conda behavior for field consistency
   - FAILURE: repodata_record.contains("depends") is false

2. track_features omission test (PASSES):
   - Tests that track_features is omitted when empty
   - Matches conda behavior to reduce JSON noise
   - Already works correctly with current implementation

3. both checksums presence test (FAILS):
   - Tests that both md5 and sha256 are always present
   - Should compute checksums from tarball when not available
   - FAILURE: repodata_record.contains("md5") is false

Test results:
- "*ensures depends/constrains*": FAILED (1 test, 1 failed)
  - depends key not present when missing from index.json
- "*omits empty track_features*": PASSED (1 test)
  - Current behavior already correct
- "*ensures both checksums*": FAILED (1 test, 1 failed)
  - md5 key not present when not computed

This is the RED phase of TDD - documenting expected behavior with
failing tests. The next commit (GREEN) will implement the fixes.

Related: https://github.com/mamba-org/mamba/issues/4095
---
 .../tests/src/core/test_package_fetcher.cpp   | 221 ++++++++++++++++++
 1 file changed, 221 insertions(+)

diff --git a/libmamba/tests/src/core/test_package_fetcher.cpp b/libmamba/tests/src/core/test_package_fetcher.cpp
index e7590d1f..5b1215ab 100644
--- a/libmamba/tests/src/core/test_package_fetcher.cpp
+++ b/libmamba/tests/src/core/test_package_fetcher.cpp
@@ -571,4 +571,225 @@ namespace
         CHECK(healed_repodata["timestamp"] == 1234567890);
         CHECK(healed_repodata["build_number"] == 42);
     }
+
+    /**
+     * Test that depends and constrains are always present as arrays
+     *
+     * PURPOSE: Verify that repodata_record.json always includes "depends" and
+     * "constrains" fields as arrays, even when they're missing from index.json.
+     *
+     * MOTIVATION: Matches conda behavior where these fields are always present.
+     * Some packages (like nlohmann_json-abi) don't have depends in index.json.
+     *
+     * Related: https://github.com/mamba-org/mamba/issues/4095
+     */
+    TEST_CASE("PackageFetcher::write_repodata_record ensures depends/constrains present")
+    {
+        auto& ctx = mambatests::context();
+        TemporaryDirectory temp_dir;
+        MultiPackageCache package_caches{ { temp_dir.path() / "pkgs" }, ctx.validation_params };
+
+        static constexpr std::string_view url = "https://conda.anaconda.org/conda-forge/linux-64/nodeps-1.0-h0_0.conda";
+        auto pkg_info = specs::PackageInfo::from_url(url).value();
+
+        const std::string pkg_basename = "nodeps-1.0-h0_0";
+
+        auto pkg_extract_dir = temp_dir.path() / "pkgs" / pkg_basename;
+        auto info_dir = pkg_extract_dir / "info";
+        fs::create_directories(info_dir);
+
+        // Create index.json WITHOUT depends or constrains (like nlohmann_json-abi)
+        nlohmann::json index_json;
+        index_json["name"] = "nodeps";
+        index_json["version"] = "1.0";
+        index_json["build"] = "h0_0";
+        // NO depends or constrains keys
+
+        {
+            std::ofstream index_file((info_dir / "index.json").std_path());
+            index_file << index_json.dump(2);
+        }
+
+        {
+            std::ofstream paths_file((info_dir / "paths.json").std_path());
+            paths_file << R"({"paths": [], "paths_version": 1})";
+        }
+
+        auto tarball_path = temp_dir.path() / "pkgs" / (pkg_basename + ".tar.bz2");
+        create_archive(pkg_extract_dir, tarball_path, compression_algorithm::bzip2, 1, 1, nullptr);
+        REQUIRE(fs::exists(tarball_path));
+
+        auto modified_pkg_info = pkg_info;
+        modified_pkg_info.filename = pkg_basename + ".tar.bz2";
+
+        fs::remove_all(pkg_extract_dir);
+
+        PackageFetcher pkg_fetcher{ modified_pkg_info, package_caches };
+
+        ExtractOptions options;
+        options.sparse = false;
+        options.subproc_mode = extract_subproc_mode::mamba_package;
+
+        bool extract_success = pkg_fetcher.extract(options);
+        REQUIRE(extract_success);
+
+        auto repodata_record_path = pkg_extract_dir / "info" / "repodata_record.json";
+        REQUIRE(fs::exists(repodata_record_path));
+
+        std::ifstream repodata_file(repodata_record_path.std_path());
+        nlohmann::json repodata_record;
+        repodata_file >> repodata_record;
+
+        // depends and constrains should always be present as empty arrays
+        REQUIRE(repodata_record.contains("depends"));
+        CHECK(repodata_record["depends"].is_array());
+        CHECK(repodata_record["depends"].empty());
+
+        REQUIRE(repodata_record.contains("constrains"));
+        CHECK(repodata_record["constrains"].is_array());
+        CHECK(repodata_record["constrains"].empty());
+    }
+
+    /**
+     * Test that track_features is omitted when empty
+     *
+     * PURPOSE: Verify that track_features is only included in repodata_record.json
+     * when it has non-empty value. Matches conda behavior.
+     *
+     * Related: https://github.com/mamba-org/mamba/issues/4095
+     */
+    TEST_CASE("PackageFetcher::write_repodata_record omits empty track_features")
+    {
+        auto& ctx = mambatests::context();
+        TemporaryDirectory temp_dir;
+        MultiPackageCache package_caches{ { temp_dir.path() / "pkgs" }, ctx.validation_params };
+
+        static constexpr std::string_view url = "https://conda.anaconda.org/conda-forge/linux-64/notf-1.0-h0_0.conda";
+        auto pkg_info = specs::PackageInfo::from_url(url).value();
+
+        const std::string pkg_basename = "notf-1.0-h0_0";
+
+        auto pkg_extract_dir = temp_dir.path() / "pkgs" / pkg_basename;
+        auto info_dir = pkg_extract_dir / "info";
+        fs::create_directories(info_dir);
+
+        // Create index.json without track_features
+        nlohmann::json index_json;
+        index_json["name"] = "notf";
+        index_json["version"] = "1.0";
+        index_json["build"] = "h0_0";
+        // NO track_features key
+
+        {
+            std::ofstream index_file((info_dir / "index.json").std_path());
+            index_file << index_json.dump(2);
+        }
+
+        {
+            std::ofstream paths_file((info_dir / "paths.json").std_path());
+            paths_file << R"({"paths": [], "paths_version": 1})";
+        }
+
+        auto tarball_path = temp_dir.path() / "pkgs" / (pkg_basename + ".tar.bz2");
+        create_archive(pkg_extract_dir, tarball_path, compression_algorithm::bzip2, 1, 1, nullptr);
+        REQUIRE(fs::exists(tarball_path));
+
+        auto modified_pkg_info = pkg_info;
+        modified_pkg_info.filename = pkg_basename + ".tar.bz2";
+
+        fs::remove_all(pkg_extract_dir);
+
+        PackageFetcher pkg_fetcher{ modified_pkg_info, package_caches };
+
+        ExtractOptions options;
+        options.sparse = false;
+        options.subproc_mode = extract_subproc_mode::mamba_package;
+
+        bool extract_success = pkg_fetcher.extract(options);
+        REQUIRE(extract_success);
+
+        auto repodata_record_path = pkg_extract_dir / "info" / "repodata_record.json";
+        REQUIRE(fs::exists(repodata_record_path));
+
+        std::ifstream repodata_file(repodata_record_path.std_path());
+        nlohmann::json repodata_record;
+        repodata_file >> repodata_record;
+
+        // track_features should be omitted when empty
+        CHECK_FALSE(repodata_record.contains("track_features"));
+    }
+
+    /**
+     * Test that both checksums are always present
+     *
+     * PURPOSE: Verify that both md5 and sha256 checksums are always present in
+     * repodata_record.json, computed from tarball if not available.
+     *
+     * Related: https://github.com/mamba-org/mamba/issues/4095
+     */
+    TEST_CASE("PackageFetcher::write_repodata_record ensures both checksums")
+    {
+        auto& ctx = mambatests::context();
+        TemporaryDirectory temp_dir;
+        MultiPackageCache package_caches{ { temp_dir.path() / "pkgs" }, ctx.validation_params };
+
+        static constexpr std::string_view url = "https://conda.anaconda.org/conda-forge/linux-64/nosum-1.0-h0_0.conda";
+        auto pkg_info = specs::PackageInfo::from_url(url).value();
+
+        const std::string pkg_basename = "nosum-1.0-h0_0";
+
+        auto pkg_extract_dir = temp_dir.path() / "pkgs" / pkg_basename;
+        auto info_dir = pkg_extract_dir / "info";
+        fs::create_directories(info_dir);
+
+        // Create index.json without checksums (which is normal)
+        nlohmann::json index_json;
+        index_json["name"] = "nosum";
+        index_json["version"] = "1.0";
+        index_json["build"] = "h0_0";
+        // NO md5 or sha256
+
+        {
+            std::ofstream index_file((info_dir / "index.json").std_path());
+            index_file << index_json.dump(2);
+        }
+
+        {
+            std::ofstream paths_file((info_dir / "paths.json").std_path());
+            paths_file << R"({"paths": [], "paths_version": 1})";
+        }
+
+        auto tarball_path = temp_dir.path() / "pkgs" / (pkg_basename + ".tar.bz2");
+        create_archive(pkg_extract_dir, tarball_path, compression_algorithm::bzip2, 1, 1, nullptr);
+        REQUIRE(fs::exists(tarball_path));
+
+        auto modified_pkg_info = pkg_info;
+        modified_pkg_info.filename = pkg_basename + ".tar.bz2";
+        // Note: pkg_info has empty md5 and sha256 (not from URL hash)
+
+        fs::remove_all(pkg_extract_dir);
+
+        PackageFetcher pkg_fetcher{ modified_pkg_info, package_caches };
+
+        ExtractOptions options;
+        options.sparse = false;
+        options.subproc_mode = extract_subproc_mode::mamba_package;
+
+        bool extract_success = pkg_fetcher.extract(options);
+        REQUIRE(extract_success);
+
+        auto repodata_record_path = pkg_extract_dir / "info" / "repodata_record.json";
+        REQUIRE(fs::exists(repodata_record_path));
+
+        std::ifstream repodata_file(repodata_record_path.std_path());
+        nlohmann::json repodata_record;
+        repodata_file >> repodata_record;
+
+        // Both checksums should be present (computed from tarball)
+        REQUIRE(repodata_record.contains("md5"));
+        CHECK_FALSE(repodata_record["md5"].get<std::string>().empty());
+
+        REQUIRE(repodata_record.contains("sha256"));
+        CHECK_FALSE(repodata_record["sha256"].get<std::string>().empty());
+    }
 }
--
2.50.1
