From 02b951e36484036b10103da9f50c145269e14270 Mon Sep 17 00:00:00 2001
From: Ben Mares <services-git-throwaway2@tensorial.com>
Date: Sat, 29 Nov 2025 20:22:58 +0100
Subject: [PATCH 08/10] fix: ensure consistent field presence and compute
 missing checksums (GREEN)

- Add logic to ensure depends and constrains are always present as arrays
- Ensure track_features is omitted when empty (not empty string)
- Compute and fill md5/sha256 checksums from tarball when missing
- Apply consistent field handling to constructor.cpp

This matches conda behavior where:
- depends and constrains are always present (even as empty arrays)
- track_features is only included when non-empty
- Both checksums are always available

Test Status: ALL TESTS PASS (GREEN phase)
- C++ test cases: 11 | 11 passed
- C++ assertions: 61 | 61 passed
- Python test cases: 3 | 3 passed

Tests fixed:
- PackageFetcher::write_repodata_record ensures depends/constrains present
- PackageFetcher::write_repodata_record ensures both checksums

Related: https://github.com/mamba-org/mamba/issues/4095
---
 libmamba/src/core/package_fetcher.cpp | 46 +++++++++++++++++++++++++++
 micromamba/src/constructor.cpp        | 27 ++++++++++++++++
 2 files changed, 73 insertions(+)

diff --git a/libmamba/src/core/package_fetcher.cpp b/libmamba/src/core/package_fetcher.cpp
index f31476d3..bd8287ab 100644
--- a/libmamba/src/core/package_fetcher.cpp
+++ b/libmamba/src/core/package_fetcher.cpp
@@ -503,6 +503,52 @@ namespace mamba
             repodata_record["size"] = fs::file_size(m_tarball_path);
         }

+        // Ensure depends and constrains are always present as arrays.
+        // Matches conda behavior where these fields are always present.
+        // Some packages (like nlohmann_json-abi) don't have depends in index.json.
+        // See GitHub issue #4095.
+        if (!repodata_record.contains("depends"))
+        {
+            repodata_record["depends"] = nlohmann::json::array();
+        }
+        if (!repodata_record.contains("constrains"))
+        {
+            repodata_record["constrains"] = nlohmann::json::array();
+        }
+
+        // Conditionally include track_features only when non-empty.
+        // Matches conda behavior to reduce JSON noise.
+        // See GitHub issue #4095.
+        if (repodata_record.contains("track_features"))
+        {
+            const auto& tf = repodata_record["track_features"];
+            bool is_empty = tf.is_null() || (tf.is_string() && tf.get<std::string>().empty())
+                            || (tf.is_array() && tf.empty());
+            if (is_empty)
+            {
+                repodata_record.erase("track_features");
+            }
+        }
+
+        // Ensure both md5 and sha256 checksums are always present.
+        // Compute from tarball if not available from PackageInfo or index.json.
+        // Use is_string() check to handle null or non-string values safely.
+        // See GitHub issue #4095.
+        auto needs_md5 = !repodata_record.contains("md5") || !repodata_record["md5"].is_string()
+                         || repodata_record["md5"].get<std::string>().empty();
+        if (needs_md5)
+        {
+            repodata_record["md5"] = validation::md5sum(m_tarball_path);
+        }
+
+        auto needs_sha256 = !repodata_record.contains("sha256")
+                            || !repodata_record["sha256"].is_string()
+                            || repodata_record["sha256"].get<std::string>().empty();
+        if (needs_sha256)
+        {
+            repodata_record["sha256"] = validation::sha256sum(m_tarball_path);
+        }
+
         std::ofstream repodata_record_file(repodata_record_path.std_path());
         repodata_record_file << repodata_record.dump(4);
     }
diff --git a/micromamba/src/constructor.cpp b/micromamba/src/constructor.cpp
index 29165c8b..9d85a90a 100644
--- a/micromamba/src/constructor.cpp
+++ b/micromamba/src/constructor.cpp
@@ -222,6 +222,33 @@ construct(Configuration& config, const fs::u8path& prefix, bool extract_conda_pk
                 repodata_record["size"] = fs::file_size(entry);
             }

+            // Ensure depends and constrains are always present as arrays.
+            // Matches conda behavior where these fields are always present.
+            // Some packages (like nlohmann_json-abi) don't have depends in index.json.
+            // See GitHub issue #4095.
+            if (!repodata_record.contains("depends"))
+            {
+                repodata_record["depends"] = nlohmann::json::array();
+            }
+            if (!repodata_record.contains("constrains"))
+            {
+                repodata_record["constrains"] = nlohmann::json::array();
+            }
+
+            // Conditionally include track_features only when non-empty.
+            // Matches conda behavior to reduce JSON noise.
+            // See GitHub issue #4095.
+            if (repodata_record.contains("track_features"))
+            {
+                const auto& tf = repodata_record["track_features"];
+                bool is_empty = tf.is_null() || (tf.is_string() && tf.get<std::string>().empty())
+                                || (tf.is_array() && tf.empty());
+                if (is_empty)
+                {
+                    repodata_record.erase("track_features");
+                }
+            }
+
             LOG_TRACE << "Writing " << repodata_record_path;
             std::ofstream repodata_record_of{ repodata_record_path.std_path() };
             repodata_record_of << repodata_record.dump(4);
--
2.50.1
