From 8bffd43cf7fa5b8f9ce76256b27e0282be0a119b Mon Sep 17 00:00:00 2001
From: Cursor Agent <cursoragent@cursor.com>
Date: Wed, 26 Nov 2025 01:02:23 +0000
Subject: [PATCH 10/11] test: add failing test for both checksums in
 repodata_record.json (RED)

Add test that verifies both md5 and sha256 checksums are always
present in repodata_record.json, even when only one is provided
(e.g., from an explicit lockfile with only md5).
---
 .../tests/src/core/test_package_fetcher.cpp   | 76 +++++++++++++++++++
 1 file changed, 76 insertions(+)

diff --git a/libmamba/tests/src/core/test_package_fetcher.cpp b/libmamba/tests/src/core/test_package_fetcher.cpp
index 133c167d..32944989 100644
--- a/libmamba/tests/src/core/test_package_fetcher.cpp
+++ b/libmamba/tests/src/core/test_package_fetcher.cpp
@@ -13,6 +13,7 @@
 #include "mamba/core/package_handling.hpp"
 #include "mamba/core/util.hpp"
 #include "mamba/fs/filesystem.hpp"
+#include "mamba/validation/tools.hpp"

 #include "mambatests.hpp"

@@ -871,4 +872,79 @@ namespace
         CHECK_FALSE(repodata_record.contains("arch"));
         CHECK_FALSE(repodata_record.contains("platform"));
     }
+
+    TEST_CASE("PackageFetcher::write_repodata_record always includes both checksums")
+    {
+        // Test that both md5 and sha256 are always written to repodata_record.json
+        // even when only one is provided (e.g., explicit lockfile with md5 only)
+
+        auto& ctx = mambatests::context();
+        TemporaryDirectory temp_dir;
+        MultiPackageCache package_caches{ { temp_dir.path() / "pkgs" }, ctx.validation_params };
+
+        const std::string pkg_basename = "checksum-test-1.0-h0_0";
+
+        // First create the package structure and archive
+        auto pkg_extract_dir = temp_dir.path() / "pkgs" / pkg_basename;
+        auto info_dir = pkg_extract_dir / "info";
+        fs::create_directories(info_dir);
+
+        nlohmann::json index_json;
+        index_json["name"] = "checksum-test";
+        index_json["version"] = "1.0";
+        index_json["build"] = "h0_0";
+
+        {
+            std::ofstream index_file((info_dir / "index.json").std_path());
+            index_file << index_json.dump(2);
+        }
+
+        {
+            std::ofstream paths_file((info_dir / "paths.json").std_path());
+            paths_file << R"({"paths": [], "paths_version": 1})";
+        }
+
+        auto tarball_path = temp_dir.path() / "pkgs" / (pkg_basename + ".tar.bz2");
+        create_archive(pkg_extract_dir, tarball_path, compression_algorithm::bzip2, 1, 1, nullptr);
+        REQUIRE(fs::exists(tarball_path));
+
+        // Now create PackageInfo with only md5 set (simulating explicit lockfile)
+        // We compute the actual md5 of the archive we just created
+        specs::PackageInfo pkg_info;
+        pkg_info.name = "checksum-test";
+        pkg_info.version = "1.0";
+        pkg_info.build_string = "h0_0";
+        pkg_info.filename = pkg_basename + ".tar.bz2";
+        pkg_info.md5 = validation::md5sum(tarball_path);  // Only md5, no sha256
+        pkg_info.sha256 = "";                              // Explicitly empty
+
+        // Verify precondition: only md5 is set
+        REQUIRE_FALSE(pkg_info.md5.empty());
+        REQUIRE(pkg_info.sha256.empty());
+
+        fs::remove_all(pkg_extract_dir);
+
+        PackageFetcher pkg_fetcher{ pkg_info, package_caches };
+
+        ExtractOptions options;
+        options.sparse = false;
+        options.subproc_mode = extract_subproc_mode::mamba_package;
+
+        bool extract_success = pkg_fetcher.extract(options);
+        REQUIRE(extract_success);
+
+        auto repodata_record_path = pkg_extract_dir / "info" / "repodata_record.json";
+        REQUIRE(fs::exists(repodata_record_path));
+
+        std::ifstream repodata_file(repodata_record_path.std_path());
+        nlohmann::json repodata_record;
+        repodata_file >> repodata_record;
+
+        // Verify that BOTH checksums are present
+        REQUIRE(repodata_record.contains("md5"));
+        CHECK_FALSE(repodata_record["md5"].get<std::string>().empty());
+
+        REQUIRE(repodata_record.contains("sha256"));
+        CHECK_FALSE(repodata_record["sha256"].get<std::string>().empty());
+    }
 }
--
2.50.1
